# Apply CIS CentOS Linux 7 Benchmark 2.2.0
# These will be run in addition to what is applied from the oel7_cis script, based on OpenSCAP findings against CIS Benchmark
---
- hosts: 127.0.0.1
  connection: local
  tasks:
    # 1.1.1.8 Ensure mounting of FAT filesystems is disabled
    - name: Ensure mounting of FAT filesystems is disabled
      lineinfile:
        path: /etc/modprobe.d/CIS.conf
        line: install vfat /bin/true
    # 1.1.2 Ensure separate partition exists for /tmp
    - name: unmask tmp.mount
      shell: systemctl unmask tmp.mount
    - name: enable tmp.mount
      shell: systemctl enable tmp.mount
    - name: Setup tmpfs on /tmp
      lineinfile:
        path: /etc/systemd/system/local-fs.target.wants/tmp.mount
        regexp: '^Options=mode=1777,strictatime$'
        line: 'Options=mode=1777,strictatime,nosuid,nodev,noexec,size=2G'
        backrefs: yes
    # 1.4.1 Ensure permissions on bootloader config are configured
    - name: Ensure permissions on bootloader config
      file:
        path: /boot/grub2/grub.cfg
        owner: root
        group: root
        mode: '0600'
    # 1.7.1.3 Ensure remote login warning banner is configured properly
    - name: Ensure remote login warning banner /etc/issue.net
      copy:
        src: issue
        dest: /etc/issue.net
        owner: root
        group: root
        mode: 0644
    - name: Ensure remote login warning banner /etc/issue
      copy:
        src: issue
        dest: /etc/issue
        owner: root
        group: root
        mode: 0644
    # 1.3.1 Ensure AIDE is installed 
    # 1.3.2 Ensure filesystem integrity is regularly checked
    - name: Install AIDE
      yum:
        name: aide
        state: latest
    - name: Copy aide.conf
      copy:
        src: aide.conf
        dest: /etc/aide.conf
        owner: root
        group: root
        mode: 0600
    - name: Check for AIDE database
      stat: path=/var/lib/aide/aide.db.gz
      register: aide_db
    - name: Initialize the AIDE database
      shell: "aide --init"
      when: not aide_db.stat.exists
    - name: Move the new AIDE database
      shell: "mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz"
      when: not aide_db.stat.exists
    - name: Add AIDE cron job
      cron:
        name: "Run AIDE check"
        job: "/usr/sbin/aide --check"
        minute: "5"
        hour: "4"
    # 3.5.3 Ensure RDS is disabled
    - name: Ensure RDS is disabled
      lineinfile:
        path: /etc/modprobe.d/CIS.conf
        line: install rds /bin/true
    # 3.5.4 Ensure TIPC is disabled
    - name: Ensure TIPC is disabled
      lineinfile:
        path: /etc/modprobe.d/CIS.conf
        line: install tipc /bin/true
    # 4.1.5 Ensure events that modify user/group information are collected
    # 4.1.6 Ensure events that modify the system's network environment are collected
    # 4.1.9 Ensure session initiation information is collected
    # 4.1.10 Ensure discretionary access control permission modification events are collected
    # 4.1.11 Ensure unsuccessful unauthorized file access attempts are collected
    # 4.1.13 Ensure successful file system mounts are collected
    # 4.1.14 Ensure file deletion events by users are collected
    # 4.1.15 Ensure changes to system administration scope (sudoers) is collected
    # 4.1.16 Ensure system administrator actions (sudolog) are collected
    # 4.1.17 Ensure kernel module loading and unloading is collected 
    - name: Copy over audit rules file
      copy:
        src: sdsc-hipaa.rules
        dest: /etc/audit/rules.d/sdsc-hipaa.rules
        owner: root
        group: root
        mode: '0644'
    # 4.2.1.3 Ensure rsyslog default file permissions configured
    - name: Ensure rsyslog default file permissions configured
      lineinfile:
        path: /etc/rsyslog.conf
        line: $FileCreateMode 0640
    # 5.1.2 Ensure permissions on /etc/crontab are configured
    - name: Ensure permissions on /etc/crontab are configured
      file:
        path: /etc/crontab
        owner: root
        group: root
        mode: '0600'
    # 5.1.3 Ensure permissions on /etc/cron.hourly are configured
    - name: Ensure permissions on /etc/cron.hourly are configured
      file:
        path: /etc/cron.hourly
        owner: root
        group: root
        mode: '0700'
    # 5.1.4 Ensure permissions on /etc/cron.daily are configured
    - name: Ensure permissions on /etc/cron.daily are configured
      file:
        path: /etc/cron.daily
        owner: root
        group: root
        mode: '0700'
    # 5.1.5 Ensure permissions on /etc/cron.weekly are configured
    - name: Ensure permissions on /etc/cron.weekly are configured
      file:
        path: /etc/cron.weekly
        owner: root
        group: root
        mode: '0700'
    # 5.1.6 Ensure permissions on /etc/cron.monthly are configured
    - name: Ensure permissions on /etc/cron.monthly are configured
      file:
        path: /etc/cron.monthly
        owner: root
        group: root
        mode: '0700'    
    # 5.1.7 Ensure permissions on /etc/cron.d are configured
    - name: Ensure permissions on /etc/cron.d are configured
      file:
        path: /etc/cron.d
        owner: root
        group: root
        mode: '0700'
    # 5.1.8 Ensure at/cron is restricted to authorized users
    - name: Ensure /etc/cron.deny doesn't exist
      file:
        path: /etc/cron.deny
        state: absent
    - name: Ensure /etc/at.deny doesn't exist
      file:
        path: /etc/at.deny
        state: absent
    - name: Create /etc/cron.allow
      file:
        path: /etc/cron.allow
        state: touch
        owner: root
        group: root
        mode: '0600'
    - name: Create /etc/at.allow
      file:
        path: /etc/at.allow
        state: touch
        owner: root
        group: root
        mode: '0600'
    # 5.2.3 Ensure SSH LogLevel is set to INFO
    - name: Ensure SSH LogLevel is set to INFO
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#LogLevel'
        line: LogLevel INFO
        backrefs: yes
    # 5.2.4 Ensure SSH X11 forwarding is disabled
    - name: Ensure SSH X11 forwarding is disabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^X11Forwarding yes'
        line: X11Forwarding no
        backrefs: yes
    # 5.2.5 Ensure SSH MaxAuthTries is set to 4 or less
    - name: Ensure SSH MaxAuthTries is set to 3
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#MaxAuthTries 6'
        line: MaxAuthTries 3
        backrefs: yes
    # 5.2.6 Ensure SSH IgnoreRhosts is enabled
    - name: Ensure SSH IgnoreRhosts is enabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#IgnoreRhosts'
        line: IgnoreRhosts yes
        backrefs: yes
    # 5.2.7 Ensure SSH HostbasedAuthentication is disabled
    - name: Ensure SSH HostbasedAuthentication is disabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '#HostbasedAuthentication no'
        line: HostbasedAuthentication no
        backrefs: yes
    # 5.2.11 Ensure only approved MAC algorithms are used
    - name: Ensure only approved MAC algorithms are used
      lineinfile:
        path: /etc/ssh/sshd_config
        line: MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com
    - name: Set Ciphers in sshd_config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^Ciphers'
        line: Ciphers aes256-ctr,aes192-ctr,aes128-ctr
        backrefs: yes
    # 5.2.13 Ensure SSH LoginGraceTime is set to one minute or less
    - name: Ensure SSH LoginGraceTime is set to one minute
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#LoginGraceTime"
        line: LoginGraceTime 60
        backrefs: yes
    # 5.3.1 Ensure password creation requirements are configured 
    - name: Copy over pwquality config file
      copy:
        src: pwquality.conf
        dest: /etc/security/pwquality.conf
        owner: root
        group: root
        mode: '0644'
    # 5.3.2 Ensure lockout for failed password attempts is configured
    - name: Copy over password-auth file
      copy:
        src: password-auth-ac
        dest: /etc/pam.d/password-auth-ac
        owner: root
        group: root
        mode: '0644'
    - name: Copy over system-auth file
      copy:
        src: system-auth-ac
        dest: /etc/pam.d/system-auth-ac
        owner: root
        group: root
        mode: '0644'
    # 5.3.3 Ensure password reuse is limited
    - name: Uncomment pam_wheel.so use_uid
      lineinfile: 
        path: /etc/pam.d/su
        regexp: '^#auth\s.*required\s.*pam_wheel.so use_uid'
        line: 'auth            required        pam_wheel.so use_uid'
        backrefs: yes
    # 5.4.1.2 Ensure minimum days between password changes is 7 or more
    - name: Ensure minimum days between password changes is 7
      lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MIN_DAYS'
        line: 'PASS_MIN_DAYS 7'
        backrefs: yes
    # 5.4.4 Ensure default user umask is 027 or more restrictive
    - name: Set umask 027 for user files in profile
      lineinfile:
        path: /etc/profile
        regexp: '    umask'
        line: '    umask 027'
        backrefs: yes
    - name: Set umask 027 for user files in bashrc
      lineinfile:
        path: /etc/bashrc
        regexp: '       umask'
        line: '       umask 027'
        backrefs: yes
    # 5.4.5 Ensure default user shell timeout is 900 seconds or less
    - name: Ensure default user shell timeout is 600 seconds in /etc/bashrc
      lineinfile:
        path: /etc/bashrc
        line: TMOUT=600
    - name: Ensure default user shell timeout is 600 seconds in /etc/profile
      lineinfile:
        path: /etc/profile
        line: TMOUT=600
    # 6.2.8 Ensure users' home directories permissions are 750 or more restrictive
    # During an audit, it was found that /home/cwagent did not exist
    - name: Register for Ansible check if user cwagent found
      shell: "cat /etc/passwd | grep cwagent | awk -F : '{print $1}'"
      register: user_cwagent
    - name: Create cwagent home dir
      when: '"cwagent" in user_cwagent.stdout_lines'
      file:
        path: /home/cwagent
        state: directory
        owner: cwagent
        group: cwagent
        mode: '0700'
        